# Nginx Reverse Proxy Configuration
# This config makes Nginx act as a "traffic cop" - it receives all incoming
# requests on port 80 and routes them to the right service based on the URL.

# 'events' block is required by Nginx - controls how it handles connections
events {
    worker_connections 1024;  # Max simultaneous connections per worker
}

http {
    # UPSTREAM BLOCKS - Define where your services live
    # These are like address book entries. We give each service a name that
    # Nginx can use to forward requests.
    
    upstream frontend {
        server frontend:3000;  # "frontend" is the service name in docker-compose
    }

    upstream backend {
        server backend:8000;   # "backend" is the service name in docker-compose
    }

    # SERVER BLOCK - The main routing logic
    server {
        listen 80;              # Listen on port 80 (standard HTTP)
        server_name localhost;  # Accept requests for any hostname

        # SECURITY HEADERS
        # These protect against common web vulnerabilities
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

        # API ROUTES → Backend
        # Any request starting with /api/ gets forwarded to the FastAPI backend.
        # The ~ means "regex match", ^/api/ means "starts with /api/"
        location ~ ^/api/ {
            proxy_pass http://backend;   # Forward to our backend upstream
            
            # These headers tell the backend about the original request:
            proxy_set_header Host $host;                    # Original hostname
            proxy_set_header X-Real-IP $remote_addr;        # Client's real IP
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;     # http or https
            
            # Increase timeouts for slow API calls (AI recipe generation etc)
            proxy_read_timeout 120s;
            proxy_connect_timeout 120s;
        }

        # EVERYTHING ELSE → Frontend
        # All other requests (/, /recipes, /pantry, JS/CSS files, etc) go to Next.js
        location / {
            proxy_pass http://frontend;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support - CRITICAL for Next.js hot reload in dev mode
            # Without these, you'd have to manually refresh the page after changes
            proxy_http_version 1.1;                         # WebSocket needs HTTP/1.1
            proxy_set_header Upgrade $http_upgrade;         # WebSocket upgrade header
            proxy_set_header Connection "upgrade";          # Keep connection alive
        }

        # Next.js Hot Reload WebSocket (development only)
        location /_next/webpack-hmr {
            proxy_pass http://frontend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
